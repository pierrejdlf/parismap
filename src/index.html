<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    
    <!-- <title ng-bind="pageTitle"></title> -->

    <!-- social media tags -->
<!--     <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@joshdmiller">
    <meta name="twitter:title" content="ngBoilerplate">
    <meta name="twitter:description" content="Non-Trivial AngularJS Made Easy: Everything you need to kickstart AngularJS projects: a best-practice directory structure, an intelligent build system, and the best web design libraries around.">
    <meta name="twitter:creator" content="@joshdmiller">
    <meta name="twitter:image:src" content="https://a248.e.akamai.net/assets.github.com/images/modules/logos_page/Octocat.png?1366128846">
    <meta property="og:title" content="ngBoilerplate" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="http://bit.ly/ngBoilerplate" />
    <meta property="og:image" content="https://a248.e.akamai.net/assets.github.com/images/modules/logos_page/Octocat.png?1366128846" />
    <meta property="og:description" content="3 sentences description of project"> -->

    <link href='http://fonts.googleapis.com/css?family=Lato|Source+Sans+Pro:200,400' rel='stylesheet' type='text/css'>

<!-- @if NODE_ENV == 'DEVELOPMENT' -->

    <script type="text/javascript" src="../vendor/underscore/underscore-min.js"></script>
    <script type="text/javascript" src="../vendor/zepto/src/zepto.js"></script>
    <script type="text/javascript" src="../vendor/zepto/src/event.js"></script>
    <script type="text/javascript" src="../vendor/zepto/src/ajax.js"></script>

    <script type="text/javascript" src="../vendor/handlebars/handlebars.js"></script>

    <script type="text/javascript" src="../vendor/leaflet/leaflet.js"></script>
    <link rel="stylesheet" type="text/css" href="../vendor/leaflet/leaflet.css"/>
    
    <script type="text/javascript" src="../vendor/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script type="text/javascript" src="../vendor/leaflet.bouncemarker/bouncemarker.js"></script>
    <script type="text/javascript" src="../vendor/leaflet.locatecontrol/src/L.Control.Locate.js"></script>
    <link rel="stylesheet" type="text/css" href="../vendor/leaflet.locatecontrol/src/L.Control.Locate.css"/>

    <link rel="stylesheet" type="text/css" href="../vendor/font-awesome/css/font-awesome.css"/>

    <!--
    <script type="text/javascript" src="../vendor/leaflet-font-awesome/dist/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" type="text/css" href="../vendor/leaflet-font-awesome/dist/leaflet.awesome-markers.css"/>
    -->

    <script type="text/javascript" src="../vendor/swiper/dist/idangerous.swiper.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../vendor/swiper/dist/idangerous.swiper.css"/>

    <script type="text/javascript" src="../vendor/moment/moment.js"></script>

    <!-- <script src="../vendor/leaflet.groupedlayercontrol/src/leaflet.groupedlayercontrol.js"></script> -->

    <!-- <link rel="stylesheet" href="../vendor/responsive-nav/responsive-nav.css"> -->

    <script type="text/javascript" src="./js/plouf.js"></script>

    <link rel="stylesheet/less" type="text/css" href="./css/style.less" />
    <script type="text/javascript" src="../vendor/less/dist/less-1.6.2.min.js"></script>


<!-- @endif -->
<!-- @if NODE_ENV == 'PRODUCTION' -->
  
    <!-- <script src="http://app.eventsourcehq.com/es.js"></script> -->
    <!-- <script type="text/javascript" src="./vendor/eshq/index.js"></script> -->

    <script type="text/javascript" src="./js/parismap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="./css/parismap.css"/>

<!-- @endif -->


    </head>

    <body>
    <!--
      <div id="locateMask">
        <div>please allow browser geoloc</div>
        <i class="fa fa-spinner fa-spin fa-2x fa-inverse"></i>
      </div>
    -->

      <!-- <div id="menu"></div> -->
      <div class="container">

        <div id="map"></div>

        <div id="swiper" class="swiper-container">
          <div class="swiper-wrapper"></div>
        </div>

      </div>
    </body>

    <script id="plouf-template-evt" type="text/x-handlebars-template">
      <div class="plouf-container {{markertype}}">
        <!--<div class="arrow"></div>-->

        <div class="content">
          <div class="meta">
            <!--<i class="fa fa-location-arrow"></i>-->
            <a class="link" href="{{link}}" target="_blank"><div class="address">{{place}} - {{address}}</div></a>
          </div>

          <div class="title">{{title}}</div>
          <div class="text">{{text}}</div>

          <div class="seemore"><a href="{{link}}" target="_blank">read more @{{papi}}</a></div>
          <div class="ellipsis"></div>
        </div>

      </div>
    </script>

    <script id="plouf-template-msg" type="text/x-handlebars-template">
      <div class="plouf-container {{markertype}}">
        <!--<div class="arrow"></div>-->

        <div class="content">
          <!--
          <div class="meta">
            <div class="date">{{formatdate date}}</div>
            <a class="link" href="http://twitter.com/{{user.id}}" target="_blank">@{{user.name}}</a>
          </div>
          -->

          <div class="word">{{{text}}}</div>
        </div>

      </div>
    </script>


    <!-- script -->
    <script>

    function getURLParameter(name) {return decodeURI((RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]);}

    Handlebars.registerHelper('formatdate', function(date) {
      try {
        var datestr = moment(date.start).format("HH[h]mm")+"-"+moment(date.end).format("HH[h]mm");
        return new Handlebars.SafeString(datestr);
      } catch(er) {
        return "error";
      }
    });
    Handlebars.registerHelper('splitype', function(type) {
      return type.split("_")[1];
    });

    var EVENT_ICONS = {
        'event_demosphere':     'bullhorn',
        'event_lylo':           'eye',
        'event_quefaire':       'home',
        'event_sowprog':        'lock',
        'event_cibul':          'flash',
        'event_oneheart':       'globe',
        'event_opendatasoft':   'gift',
        'event_calenda':        'briefcase',
        'event_linternaute':    'sort-amount-desc'
    };

    $(function(){
        //L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {styleId: 999,   attribution: cloudmadeAttribution}),

        var configs = {};

        ////////////////////////////////////////////
        configs['parisevents'] = {
          baseLayer: L.tileLayer('http://a.tiles.mapbox.com/v3/minut.map-zvhmz6wx/{z}/{x}/{y}.jpg70', {styleId: 22677, attribution: cloudmadeAttribution}), // normal paris
          markers: {
              "event_cibul": 'evt',
              "event_demosphere": 'evt',
              "event_lylo": 'evt',
              "event_oneheart": 'evt',
              "event_opendatasoft": 'evt',
              "event_quefaire": 'evt',
              "event_sowprog": 'evt',
              "event_calenda": 'evt',
              "event_linternaute": 'evt'
          },
        };


        ////////////////////////////////////////////
        configs['twitter'] = {
          baseLayer: L.tileLayer('http://a.tiles.mapbox.com/v3/minut.map-qgm940aa/{z}/{x}/{y}.jpg70', {styleId: 22677, attribution: cloudmadeAttribution}), // black
          markers: {
              "tweet": 'msg',
              "cdlm": 'msg',
              "geolocate.csv": 'msg',
              "sample.csv": 'msg',
              "story.csv": 'msg',
          },
        };


        ////////////////////////////////////////////
        configs['europewords'] = {
          baseLayer: L.tileLayer('http://a.tiles.mapbox.com/v3/minut.hflfi81j/{z}/{x}/{y}.jpg70', {styleId: 22677, attribution: cloudmadeAttribution}), // whole europe
          markers: {
            'https://a.tiles.mapbox.com/v3/minut.hflfi81j/markers.geojson':'word'
          },
        };


        ////////////////////////////////////////////
        // which config to load ?
        var options = {};
        if(window.location.hash=='#msg')
          options = configs['twitter'];
        else if(window.location.hash=='#emi')
          options = configs['europewords'];
        else
          options = configs['parisevents'];
        
        ////////////////////////////////////////////
        var cloudmadeAttribution = 'MD &copy;2011 OSM contribs, Img &copy;2011 CloudMade';
        var dev = window.location.hostname == "localhost";

        // init map on div, with all required options
        var p = Ploufmap(_.extend(options, {
          map: "map", // map div id (carefull with css !)
          dev: dev,
          baseUrl: dev ? "http://localhost:8080" : "http://beta.parismappartient.fr",

          leaflet: {
            // here you could override default leaflet map options
            //minZoom: 2,
            //maxZoom: 18,
            //scrollWheelZoom: false,
          },

          clusterize: true,

          // handlebar template for a slide showing a plouf
          templates: {
            word: Handlebars.compile($("#plouf-template-msg").html()),
            msg: Handlebars.compile($("#plouf-template-msg").html()),
            evt: Handlebars.compile($("#plouf-template-evt").html())
          },

          // define icons
          icons: {
            // icon_example: function(data) {
            //  return L.icon({
            //     iconUrl: 'http://cdn.leafletjs.com/leaflet-0.6.4/images/marker-icon.png',
            //     shadowUrl: 'http://cdn.leafletjs.com/leaflet-0.6.4/images/marker-shadow.png',
            //     iconSize: [25, 41],
            //     iconAnchor: [12, 40],
            //     popupAnchor: [0, -40],
            //     shadowSize: [41, 41],
            //     shadowAnchor: [12, 40]
            // })
            // },
            // following could allow you to use font-awesome standard markers
            // http://fortawesome.github.io/Font-Awesome/icons/
            // 'red', 'darkred', 'orange', 'green', 'darkgreen', 'blue', 'purple', 'darkpuple', 'cadetblue'
            // icon_awesome: L.AwesomeMarkers.icon({
            //         prefix:         'fa',
            //         icon:           value.split("_")[0],
            //         markerColor:    value.split("_")[1]
            //         //iconColor:#BBBBBB,
            //         //spin:true,
            //     });
            ///////////////////////////////////////////////////
            word: function(p,clustCount) {              
              var cla = 'word';
              if(clustCount>1) {
                cla += " cluster";
              }
              return L.divIcon({
                iconSize: [110, 50],
                html: "<div class='"+cla+"'>"+p.title+"</div>",
                popupAnchor: [0, 0]
              });
            },
            ///////////////////////////////////////////////////
            msg: function(p,clustCount) {
              var cla = 'msg';
              if(clustCount>1) {
                cla += " cluster";
              }

              return L.divIcon({
                iconSize: [110, 50],
                html: "<div class='"+cla+"'>"+p.words.join("<br>")+"</div>",
                popupAnchor:  [0, 0]
              });
            },
            ///////////////////////////////////////////////////
            evt: function(p,clustCount) {
              var cla = 'evt';
              var ic = EVENT_ICONS[p.ptype];
              var interval = false ; //p.date.start!=p.date.end;
              var ti = moment(p.date.start).format("HH:mm");
              // also end date ?
              if(interval)
                ti += " - "+moment(p.date.end).format("HH:mm");
              var w = interval ? 115 : 68;
              
              html = "<div class='"+cla+"'><i class='fa fa-"+ic+"'></i><span>"+ti+"</span></div>";

              if(clustCount>1) {
                cla += " cluster";
                ti = clustCount;
                ic = 'calendar';
                w = clustCount>9 ? (clustCount>99 ? 56 : 48) : 40;
                html = "<div class='"+cla+"'><span>"+ti+"</span><i class='fa fa-"+ic+"'></i></div>";
              }
              
              return L.divIcon({
                iconSize:     [w, 10],
                html:         html,
                popupAnchor:  [0, 0]
              });
            }
            ///////////////////////////////////////////////////
          }
        }));
    });
    </script>

</html>